{% extends "ventas/base_dashboard.html" %}
{% load static %}
{% block title %}Catálogo de Productos{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/catalogo.css' %}" />


<div class="catalogo-container">
  <!-- Botón para abrir carrito -->
  <div class="catalogo-carrito-btn">
    <a href="{% url 'carrito' %}" id="boton-ver-carrito" class="catalogo-carrito-link" title="Ver carrito">
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="#FFD600" style="margin-right:8px;vertical-align:middle;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2 9m13-9l2 9m-5-9V5a2 2 0 10-4 0v4" />
      </svg>
      <span id="cantidad-carrito">{{ total_carrito }}</span>
    </a>
  </div>

  <!-- Título -->
  <h1 class="catalogo-title">Zapatos <span class="catalogo-title-count">[{{ productos|length }}]</span></h1>

  <!-- Categorías tipo pestañas -->
  <nav class="catalogo-categorias-nav">
    {% for cat in categorias %}
      <a href="?categoria={{ cat }}" class="catalogo-categoria {% if request.GET.categoria == cat %}active{% endif %}">
        {{ cat }}
      </a>
    {% endfor %}
  </nav>

  <!-- Filtros con dropdown -->
  <div class="catalogo-filtros">
    <div>
      <select onchange="location.href='?marca='+this.value" class="catalogo-filtro-select">
        <option value="">Marca</option>
        {% for m in marcas %}
          <option value="{{ m }}">{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <select onchange="location.href='?talla='+this.value" class="catalogo-filtro-select">
        <option value="">Talla</option>
        {% for t in tallas %}
          <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <select onchange="location.href='?color='+this.value" class="catalogo-filtro-select">
        <option value="">Color</option>
        {% for c in colores %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <a href="{% url 'catalogo_productos' %}" class="catalogo-filtro-clear">Borrar todos los filtros</a>
  </div>

  <!-- Productos grid -->
  <div class="catalogo-productos-grid">
    {% for producto in productos %}
      <div class="catalogo-producto-card">
        <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="catalogo-producto-img">
        <div class="catalogo-producto-info">
          <h3 class="catalogo-producto-nombre">{{ producto.nombre }}</h3>
          {% if producto.talla %}
            <p class="catalogo-producto-talla">Talla: {{ producto.talla }}</p>
          {% endif %}
          <p class="catalogo-producto-stock">Stock: {{ producto.cantidad }}</p>
          <p class="catalogo-producto-precio">S/ {{ producto.precio|floatformat:2 }}</p>
          <form method="post" action="{% url 'agregar_al_carrito' producto.id %}" class="agregar-carrito-form">
            {% csrf_token %}
            <input type="hidden" name="nombre_producto" value="{{ producto.nombre }}">
            <input type="hidden" name="imagen_producto" value="{{ producto.imagen.url }}">
            <input type="hidden" name="precio_producto" value="{{ producto.precio }}">
            <div class="catalogo-cantidad-selector">
              <button type="button" class="catalogo-cantidad-btn" onclick="stepCantidad(this, -1)">−</button>
              <input type="number" name="cantidad" value="1" min="1" max="{{ producto.cantidad }}" class="catalogo-cantidad-input">
              <button type="button" class="catalogo-cantidad-btn" onclick="stepCantidad(this, 1)">+</button>
            </div>
            <button type="submit" class="catalogo-agregar-btn">Agregar al carrito</button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Carrito flotante -->
<div id="carrito-flotante" class="catalogo-carrito-flotante">
  <h3 class="catalogo-carrito-flotante-title">Producto agregado al carrito</h3>
  <div id="detalle-producto-agregado" class="catalogo-carrito-flotante-detalle"></div>
  <a href="{% url 'carrito' %}" class="catalogo-carrito-flotante-btn">Ver carrito y continuar compra</a>
</div>

<script>
  function stepCantidad(btn, delta) {
    const input = btn.parentElement.querySelector('input[name="cantidad"]');
    let value = parseInt(input.value) || 1;
    value += delta;
    if (value < parseInt(input.min)) value = parseInt(input.min);
    if (value > parseInt(input.max)) value = parseInt(input.max);
    input.value = value;
  }

  function mostrarCarrito(producto) {
    const carritoFlotante = document.getElementById('carrito-flotante');
    const detalle = document.getElementById('detalle-producto-agregado');
    const precioTotal = (producto.precio * producto.cantidad).toFixed(2);

    detalle.innerHTML = `
      <div class="flex items-center gap-4">
        <img src="${producto.imagen}" alt="${producto.nombre}" class="w-16 h-16 object-contain rounded border">
        <div>
          <p class="font-semibold">${producto.nombre}</p>
          <p class="text-sm text-gray-600">Cantidad: ${producto.cantidad}</p>
          <p class="text-red-600 font-bold">S/ ${precioTotal}</p>
        </div>
      </div>
    `;

    carritoFlotante.classList.remove('hidden');

    setTimeout(() => {
      carritoFlotante.classList.add('hidden');
    }, 4000);

    // Actualizar el contador del carrito en el frontend
    const contador = document.getElementById('cantidad-carrito');
    contador.textContent = parseInt(contador.textContent) + producto.cantidad;
  }

  document.querySelectorAll('form.agregar-carrito-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const url = this.action;
      const formData = new FormData(this);
      const cantidadInput = this.querySelector('input[name="cantidad"]');
      const cantidad = parseInt(cantidadInput.value) || 1;

      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const producto = {
            nombre: this.querySelector('input[name="nombre_producto"]').value,
            imagen: this.querySelector('input[name="imagen_producto"]').value,
            cantidad: cantidad,
            precio: parseFloat(this.querySelector('input[name="precio_producto"]').value)
          };
          mostrarCarrito(producto);

          // Actualizar contador con cantidad total real del backend
          const contador = document.getElementById('cantidad-carrito');
          contador.textContent = data.total_cantidad;
        } else {
          alert("Error al agregar producto al carrito.");
        }
      })
      .catch(() => alert("Error en la comunicación con el servidor."));
    });
  });
</script>
{% endblock %}
