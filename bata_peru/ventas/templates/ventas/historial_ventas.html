{% extends "ventas/base_dashboard.html" %}
{% load tz %}
{% block title %}Historial de Ventas{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-6">üìú Historial de Ventas</h2>

<form method="GET" class="mb-6 bg-white p-4 rounded shadow flex flex-col md:flex-row items-end md:items-center gap-4">
  <div>
    <label class="block text-sm font-medium text-gray-600">Desde:</label>
    <input type="date" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}" class="border rounded px-2 py-1 w-full">
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-600">Hasta:</label>
    <input type="date" name="fecha_fin" value="{{ request.GET.fecha_fin }}" class="border rounded px-2 py-1 w-full">
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-600">Estado:</label>
    <select name="estado" class="border rounded px-2 py-1 w-full">
      <option value="">Todos</option>
      <option value="activa" {% if request.GET.estado == "activa" %}selected{% endif %}>Activas</option>
      <option value="anulada" {% if request.GET.estado == "anulada" %}selected{% endif %}>Anuladas</option>
    </select>
  </div>
  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
    üîç Filtrar
  </button>
</form>

<table class="w-full bg-white shadow rounded overflow-hidden text-sm">
  <thead class="bg-blue-100 text-left">
    <tr>
      <th class="p-3">Producto(s)</th>
      <th class="p-3">Cantidad(es)</th>
      <th class="p-3">Tipo de Pago</th>
      <th class="p-3">Pag√≥</th>
      <th class="p-3">Vuelto</th>
      <th class="p-3">Fecha</th>
      <th class="p-3">Total</th>
      <th class="p-3">Estado</th>
    </tr>
  </thead>
  <tbody>
    {% for venta in ventas %}
    <tr class="border-t hover:bg-gray-50 {% if venta.anulada %}bg-gray-100 text-gray-400 line-through{% endif %}">
      <td class="p-3">
        <ul class="list-disc pl-4">
          {% for item in venta.detalleventa_set.all %}
            <li>{{ item.producto.nombre }}</li>
          {% endfor %}
        </ul>
      </td>
      <td class="p-3">
        <ul class="pl-2">
          {% for item in venta.detalleventa_set.all %}
            <li>{{ item.cantidad }}</li>
          {% endfor %}
        </ul>
      </td>
      <td class="p-3">{{ venta.get_tipo_pago_display }}</td>
      <td class="p-3">S/ {{ venta.monto_pagado|floatformat:2 }}</td>
      <td class="p-3">S/ {{ venta.vuelto|floatformat:2 }}</td>
      <td class="p-3">{{ venta.fecha|localtime|date:"Y-m-d H:i" }}</td>
      <td class="p-3">S/ {{ venta.total|floatformat:2 }}</td>
      <td class="p-3">
        {% if not venta.anulada %}
          <form method="POST" action="{% url 'solicitar_anulacion_venta' venta.id %}">
            {% csrf_token %}
            <button type="submit" class="text-sm text-red-600 hover:underline">Anular</button>
          </form>
        {% else %}
          <span class="italic">Anulada</span>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="8" class="p-4 text-center text-gray-500">A√∫n no tienes ventas registradas.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
