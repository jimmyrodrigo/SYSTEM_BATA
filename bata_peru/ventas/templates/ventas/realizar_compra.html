{% extends "ventas/base_dashboard.html" %}
{% load static %}
{% block title %}Finalizar Compra{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/compra.css' %}" />
<div class="compra-container">
  <h2 class="compra-title">Finalizar Compra</h2>
  <form method="POST" id="compraForm" class="compra-form">
    {% csrf_token %}
    <!-- Tipo de Comprobante -->
    <div style="grid-column: 1 / span 2;">
      <label>Tipo de Comprobante</label>
      <select name="tipo_comprobante" id="tipo_comprobante" required>
        <option value="boleta" {% if tipo_comprobante == 'boleta' %}selected{% endif %}>Boleta</option>
        <option value="factura" {% if tipo_comprobante == 'factura' %}selected{% endif %}>Factura</option>
      </select>
    </div>
    <!-- Tipo Documento y Número -->
    <div>
      <label>Tipo de Documento</label>
      <select name="tipo_documento" id="tipo_documento" required></select>
    </div>
    <div>
      <label>Número de Documento</label>
      <input type="text" name="documento_cliente" id="documento_cliente" required />
    </div>
    <!-- Cliente Persona Natural -->
    <div id="boleta_fields" style="grid-column: 1 / span 2;">
      <label>Nombres del Cliente</label>
      <input type="text" name="nombres_cliente" id="nombres_cliente" />
      <label>Apellidos del Cliente</label>
      <input type="text" name="apellidos_cliente" id="apellidos_cliente" />
    </div>
    <!-- Cliente Empresa -->
    <div id="factura_fields" style="grid-column: 1 / span 2; display:none;">
      <label>Razón Social</label>
      <input type="text" name="razon_social" id="razon_social" />
    </div>
    <!-- Método de Pago -->
    <div style="grid-column: 1 / span 2;">
      <label>Método de Pago</label>
      <select name="tipo_pago" required>
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta de crédito</option>
        <option value="yape">Yape / Plin</option>
      </select>
      <div class="compra-metodos">
        <img src="/media/images/pago_efectivo.png" alt="Efectivo" />
        <img src="/media/images/visa_mastercard.png" alt="Visa-Mastercard" />
        <img src="/media/images/yape.png" alt="Yape" />
        <img src="/media/images/plin.png" alt="Plin" />
      </div>
    </div>
    <!-- Pago y Vuelto -->
    <div>
      <label>Monto Pagado</label>
      <input type="number" step="0.01" name="monto_pagado" id="monto_pagado" placeholder="Ej: 100.00" required />
    </div>
    <div>
      <label>Vuelto</label>
      <input type="text" id="vuelto_mostrado" readonly />
    </div>
  </form>
  <hr style="margin:32px 0;">
  <div class="compra-resumen">
    <h3 class="compra-resumen-title">Resumen de la Compra</h3>
    <ul class="compra-resumen-list">
      {% for item in productos %}
        <li>
          <span>{{ item.producto.nombre }} x{{ item.cantidad }}</span>
          <span>Precio unitario: S/ {{ item.precio_unitario_real|floatformat:2 }}</span>
          <span>S/ {{ item.subtotal|floatformat:2 }}</span>
        </li>
      {% endfor %}
    </ul>
    <div class="compra-resumen-row">
      <span>Subtotal:</span>
      <span>S/ {{ total|floatformat:2 }}</span>
    </div>
    <div class="compra-resumen-row">
      <span>IGV (18%):</span>
      <span>S/ {{ igv|floatformat:2 }}</span>
    </div>
    <div class="compra-resumen-total">
      <span>Total:</span>
      <span>S/ {{ total_final|floatformat:2 }}</span>
    </div>
    <button type="submit" form="compraForm" class="compra-btn">Confirmar y Generar Comprobante</button>
  </div>
</div>
<script>
  const tipoComprobante = document.getElementById('tipo_comprobante');
  const boletaFields = document.getElementById('boleta_fields');
  const facturaFields = document.getElementById('factura_fields');

  // Mostrar/ocultar campos según tipo de comprobante
  function updateTipoDocumentoOptions() {
    const tipo = tipoComprobante.value;
    tipoDocumento.innerHTML = '';
    if (tipo === 'boleta') {
      tipoDocumento.innerHTML += '<option value="dni">DNI</option>';
      tipoDocumento.innerHTML += '<option value="ce">Carné de extranjería</option>';
      tipoDocumento.innerHTML += '<option value="pasaporte">Pasaporte</option>';
      boletaFields.style.display = '';
      facturaFields.style.display = 'none';
    } else {
      tipoDocumento.innerHTML += '<option value="ruc">RUC</option>';
      boletaFields.style.display = 'none';
      facturaFields.style.display = '';
    }
    aplicarRestriccionDocumento();
    actualizarResumen();
  }

  tipoComprobante.addEventListener('change', updateTipoDocumentoOptions);
  document.addEventListener('DOMContentLoaded', updateTipoDocumentoOptions);

  const tipoDocumento = document.getElementById('tipo_documento');
  const documentoInput = document.getElementById('documento_cliente');
  const nombresInput = document.getElementById('nombres_cliente');
  const apellidosInput = document.getElementById('apellidos_cliente');
  const razonSocialInput = document.getElementById('razon_social');
  const montoPagadoInput = document.getElementById('monto_pagado');
  const vueltoField = document.getElementById('vuelto_mostrado');

  // Selección de elementos para resumen
  const resumenSubtotal = document.querySelector('.compra-resumen-row span:last-child');
  const resumenIGV = document.querySelectorAll('.compra-resumen-row span')[3];
  const resumenTotal = document.querySelector('.compra-resumen-total span:last-child');

  const maxLengthPorTipo = {
    dni: 8,
    ruc: 11,
    ce: 12,
    pasaporte: 15
  };

  let dniValido = false;
  let rucValido = false;

  const productosData = [
    {% for item in productos %}
      {
        nombre: "{{ item.producto.nombre }}",
        cantidad: {{ item.cantidad }},
        precioBase: {{ item.precio_unitario_real|floatformat:2 }},
        subtotal: {{ item.subtotal|floatformat:2 }}
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  function actualizarResumen() {
    const tipo = tipoComprobante.value;
    let totalBase = 0;
    productosData.forEach((item) => {
      totalBase += item.precioBase * item.cantidad;
    });
    let igv = tipo === 'factura' ? totalBase * 0.18 : 0;
    let totalFinal = totalBase + igv;
    if (resumenSubtotal) resumenSubtotal.textContent = totalBase.toFixed(2);
    if (resumenIGV) resumenIGV.textContent = igv.toFixed(2);
    if (resumenTotal) resumenTotal.textContent = totalFinal.toFixed(2);
    actualizarVuelto();
  }

  function actualizarVuelto() {
    const pagado = parseFloat(montoPagadoInput.value);
    const total = resumenTotal ? parseFloat(resumenTotal.textContent) : 0;
    if (!isNaN(pagado) && pagado >= total) {
      vueltoField.value = `S/ ${(pagado - total).toFixed(2)}`;
    } else {
      vueltoField.value = pagado ? "Monto insuficiente" : "";
    }
  }

  function updateTipoDocumentoOptions() {
    tipoDocumento.innerHTML = '';
    if (tipoComprobante.value === 'boleta') {
      tipoDocumento.innerHTML += '<option value="dni">DNI</option>';
      tipoDocumento.innerHTML += '<option value="ce">Carné de extranjería</option>';
      tipoDocumento.innerHTML += '<option value="pasaporte">Pasaporte</option>';
      boletaFields.style.display = '';
      facturaFields.style.display = 'none';
    } else {
      tipoDocumento.innerHTML += '<option value="ruc">RUC</option>';
      boletaFields.style.display = 'none';
      facturaFields.style.display = '';
    }
    aplicarRestriccionDocumento();
    actualizarResumen();
  }

  function aplicarRestriccionDocumento() {
    const tipo = tipoDocumento.value;
    documentoInput.value = '';
    documentoInput.placeholder = 'Ingrese número';
    documentoInput.setAttribute('maxlength', maxLengthPorTipo[tipo] || 15);
    dniValido = false;
    rucValido = false;
  }

  documentoInput.addEventListener('blur', () => {
    const tipo = tipoDocumento.value;
    const numero = documentoInput.value.trim();

    if (tipo === 'dni' && numero.length === 8) {
      fetch("{% url 'consultar_dni' %}?dni=" + numero)
        .then(res => res.json())
        .then(data => {
          if (data.nombres) {
            nombresInput.value = data.nombres;
            apellidosInput.value = `${data.apellidoPaterno} ${data.apellidoMaterno}`;
            dniValido = true;
          } else {
            dniValido = false;
          }
        })
        .catch(() => dniValido = false);
    }

    if (tipo === 'ruc' && numero.length === 11) {
      fetch("{% url 'consultar_ruc' %}?ruc=" + numero)
        .then(res => res.json())
        .then(data => {
          if (data.razonSocial) {
            razonSocialInput.value = data.razonSocial;
            rucValido = true;
          } else {
            rucValido = false;
          }
        })
        .catch(() => rucValido = false);
    }
  });

  montoPagadoInput.addEventListener('input', actualizarVuelto);
  tipoComprobante.addEventListener('change', updateTipoDocumentoOptions);
  tipoDocumento.addEventListener('change', () => {
    aplicarRestriccionDocumento();
    actualizarResumen();
  });

  document.getElementById('compraForm').addEventListener('submit', function (e) {
    const tipo = tipoDocumento.value;
    const numero = documentoInput.value.trim();
    const requerido = maxLengthPorTipo[tipo];
    const pagado = parseFloat(montoPagadoInput.value);
    const total = parseFloat(resumenTotal.textContent);

    if (numero.length !== requerido) {
      e.preventDefault();
      alert(`⚠️ El número de ${tipo.toUpperCase()} debe tener exactamente ${requerido} dígitos.`);
      return;
    }

    if (tipo === 'dni' && !dniValido) {
      e.preventDefault();
      alert("⚠️ El DNI ingresado no es válido según la RENIEC.");
      return;
    }

    if (tipo === 'ruc' && !rucValido) {
      e.preventDefault();
      alert("⚠️ El RUC ingresado no es válido según SUNAT.");
      return;
    }

    if (tipo === 'dni' && (!nombresInput.value.trim() || !apellidosInput.value.trim())) {
      e.preventDefault();
      alert("⚠️ Completa los nombres y apellidos del cliente.");
      return;
    }

    if (tipo === 'ruc' && !razonSocialInput.value.trim()) {
      e.preventDefault();
      alert("⚠️ Completa la razón social de la empresa.");
      return;
    }

    if (isNaN(pagado) || pagado < total) {
      e.preventDefault();
      alert("⚠️ El monto pagado no puede ser menor al total.");
      return;
    }
  });
</script>

{% endblock %}
