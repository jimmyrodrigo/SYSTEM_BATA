{% extends "ventas/base_dashboard.html" %}
{% block title %}Finalizar Compra{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-2xl font-bold text-red-700 mb-6">Finalizar Compra</h2>

  <form method="POST" id="compraForm">
    {% csrf_token %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- Tipo de Comprobante -->
      <div class="md:col-span-2">
        <label class="block mb-1 font-medium">Tipo de Comprobante</label>
        <select name="tipo_comprobante" id="tipo_comprobante" required class="w-full border rounded p-2">
          <option value="boleta">Boleta</option>
          <option value="factura">Factura</option>
        </select>
      </div>

      <!-- Tipo de Documento -->
      <div class="md:col-span-2">
        <label class="block mb-1 font-medium">Tipo de Documento</label>
        <select name="tipo_documento" id="tipo_documento" required class="w-full border rounded p-2"></select>
      </div>

      <!-- Boleta -->
      <div id="boleta_fields" class="md:col-span-2">
        <label class="block mb-1 font-medium">Nombres del cliente</label>
        <input type="text" name="nombres_cliente" id="nombres_cliente" class="w-full border rounded p-2 mb-2" />
        <label class="block mb-1 font-medium">Apellidos del cliente</label>
        <input type="text" name="apellidos_cliente" id="apellidos_cliente" class="w-full border rounded p-2 mb-2" />
      </div>

      <!-- Factura -->
      <div id="factura_fields" class="md:col-span-2 hidden">
        <label class="block mb-1 font-medium">Razón Social</label>
        <input type="text" name="razon_social" id="razon_social" class="w-full border rounded p-2 mb-2" />
      </div>

      <!-- Número de documento -->
      <div class="md:col-span-2">
        <label class="block mb-1 font-medium">Número de Documento</label>
        <input type="text" name="documento_cliente" id="documento_cliente" required class="w-full border rounded p-2" />
      </div>

      <!-- Método de pago -->
      <div class="md:col-span-2">
        <label class="block mb-1 font-medium">Método de Pago</label>
        <select name="tipo_pago" required class="w-full border rounded p-2">
          <option value="efectivo">Efectivo</option>
          <option value="tarjeta">Tarjeta de crédito</option>
          <option value="yape">Yape / Plin</option>
        </select>
        <div class="flex gap-4 mt-2">
          <img src="/media/image/pago_efectivo.png" alt="Efectivo" class="h-8" />
          <img src="/media/image/visa_mastercard.png" alt="Visa-Mastercard" class="h-8" />
          <img src="/media/image/yape.png" alt="Yape" class="h-8" />
          <img src="/media/image/plin.png" alt="Plin" class="h-8" />
        </div>
      </div>

      <!-- Monto pagado -->
      <div class="md:col-span-2">
        <label class="block mb-1 font-medium">Monto pagado por el cliente</label>
        <input type="number" step="0.01" name="monto_pagado" id="monto_pagado"
               class="w-full border rounded p-2 bg-yellow-50 text-right font-bold"
               placeholder="Ej: 100.00" required>
      </div>

      <!-- Vuelto -->
      <div class="md:col-span-2">
        <label class="block mb-1 font-medium">Vuelto</label>
        <input type="text" id="vuelto_mostrado"
               class="w-full border rounded p-2 bg-green-50 text-right font-semibold" readonly>
      </div>
    </div>

    <hr class="my-6">

    <h3 class="text-xl font-semibold mb-2">Resumen de la compra</h3>
    <ul class="space-y-2 mb-4">
      {% for item in productos %}
        <li class="flex justify-between border-b pb-1 text-sm">
          <span>{{ item.producto.nombre }} x{{ item.cantidad }}</span>
          <span>S/ {{ item.subtotal|floatformat:2 }}</span>
        </li>
      {% endfor %}
    </ul>

    <p class="text-sm">Subtotal: <strong>S/ {{ total|floatformat:2 }}</strong></p>
    <p class="text-sm">IGV (18%): <strong>S/ {{ igv|floatformat:2 }}</strong></p>
    <p class="text-base mt-1">Total: <strong>S/ {{ total_final|floatformat:2 }}</strong></p>

    <div class="mt-6">
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
        Confirmar y generar comprobante
      </button>
    </div>
  </form>
</div>

<script>
  const tipoComprobante = document.getElementById('tipo_comprobante');
  const tipoDocumento = document.getElementById('tipo_documento');
  const documentoInput = document.getElementById('documento_cliente');
  const boletaFields = document.getElementById('boleta_fields');
  const facturaFields = document.getElementById('factura_fields');
  const nombresInput = document.getElementById('nombres_cliente');
  const apellidosInput = document.getElementById('apellidos_cliente');
  const razonSocialInput = document.getElementById('razon_social');

  let dniValido = false;
  let rucValido = false;

  const maxLengthPorTipo = {
    dni: 8,
    ruc: 11,
    ce: 12,
    pasaporte: 15
  };

  function updateTipoDocumentoOptions() {
    tipoDocumento.innerHTML = '';
    if (tipoComprobante.value === 'boleta') {
      tipoDocumento.innerHTML += '<option value="dni">DNI</option>';
      tipoDocumento.innerHTML += '<option value="ce">Carné de extranjería</option>';
      tipoDocumento.innerHTML += '<option value="pasaporte">Pasaporte</option>';
      boletaFields.classList.remove('hidden');
      facturaFields.classList.add('hidden');
    } else {
      tipoDocumento.innerHTML += '<option value="ruc">RUC</option>';
      boletaFields.classList.add('hidden');
      facturaFields.classList.remove('hidden');
    }
    aplicarRestriccionDocumento();
  }

  function aplicarRestriccionDocumento() {
    const tipo = tipoDocumento.value;
    documentoInput.value = '';
    documentoInput.placeholder = 'Ingrese número';
    documentoInput.setAttribute('maxlength', maxLengthPorTipo[tipo] || 15);
    dniValido = false;
    rucValido = false;
  }

  tipoComprobante.addEventListener('change', updateTipoDocumentoOptions);
  tipoDocumento.addEventListener('change', aplicarRestriccionDocumento);

  document.addEventListener('DOMContentLoaded', () => {
    updateTipoDocumentoOptions();
  });

  documentoInput.addEventListener('blur', () => {
    const tipo = tipoDocumento.value;
    const numero = documentoInput.value.trim();

    if (tipo === 'dni' && numero.length === 8) {
      fetch("{% url 'consultar_dni' %}?dni=" + numero)
        .then(res => res.json())
        .then(data => {
          if (data.nombres) {
            nombresInput.value = data.nombres;
            apellidosInput.value = `${data.apellidoPaterno} ${data.apellidoMaterno}`;
            dniValido = true;
          } else {
            dniValido = false;
          }
        })
        .catch(() => dniValido = false);
    }

    if (tipo === 'ruc' && numero.length === 11) {
      fetch("{% url 'consultar_ruc' %}?ruc=" + numero)
        .then(res => res.json())
        .then(data => {
          if (data.razonSocial) {
            razonSocialInput.value = data.razonSocial;
            rucValido = true;
          } else {
            rucValido = false;
          }
        })
        .catch(() => rucValido = false);
    }
  });

  // Calcular vuelto en tiempo real
  document.getElementById('monto_pagado').addEventListener('input', () => {
    const pagado = parseFloat(document.getElementById('monto_pagado').value);
    const total = {{ total_final|floatformat:2 }};
    const vueltoField = document.getElementById('vuelto_mostrado');

    if (!isNaN(pagado) && pagado >= total) {
      const vuelto = (pagado - total).toFixed(2);
      vueltoField.value = `S/ ${vuelto}`;
    } else {
      vueltoField.value = pagado ? "Monto insuficiente" : "";
    }
  });

  document.getElementById('compraForm').addEventListener('submit', function (e) {
    const tipo = tipoDocumento.value;
    const numero = documentoInput.value.trim();
    const requerido = maxLengthPorTipo[tipo];
    const pagado = parseFloat(document.getElementById('monto_pagado').value);
    const total = {{ total_final|floatformat:2 }};

    if (numero.length !== requerido) {
      e.preventDefault();
      alert(`⚠️ El número de ${tipo.toUpperCase()} debe tener exactamente ${requerido} dígitos.`);
      return;
    }

    if (tipo === 'dni' && !dniValido) {
      e.preventDefault();
      alert("⚠️ El DNI ingresado no es válido según la RENIEC.");
      return;
    }

    if (tipo === 'ruc' && !rucValido) {
      e.preventDefault();
      alert("⚠️ El RUC ingresado no es válido según SUNAT.");
      return;
    }

    if (tipo === 'dni' && (!nombresInput.value.trim() || !apellidosInput.value.trim())) {
      e.preventDefault();
      alert("⚠️ Completa los nombres y apellidos del cliente.");
      return;
    }

    if (tipo === 'ruc' && !razonSocialInput.value.trim()) {
      e.preventDefault();
      alert("⚠️ Completa la razón social de la empresa.");
      return;
    }

    if (isNaN(pagado) || pagado < total) {
      e.preventDefault();
      alert("⚠️ El monto pagado no puede ser menor al total.");
      return;
    }
  });
</script>
{% endblock %}
